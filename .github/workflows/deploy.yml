on:
  push:
    branches:
      - main
  schedule:
    # Beijing Time: 6,11,16,21
    - cron: '0 22,3,8,13 * * *'
  workflow_dispatch:  
permissions:
  contents: write

name: update free subscriptions
jobs:
  update_subscriptions:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Docker
        uses: docker/setup-docker-action@v4
        with:
          version: "26.1.4"
          channel: test
      - run: docker version
      - run: docker info
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v4
      - name: update expiring date and traffic
        run: node update_subscriptions.js ${{ secrets.xboard_api_secret }} ${{ secrets.xboard_api_url }}
      - name: update subscriptions
        run: node fetch_subscriptions.js ${{ secrets.xboard_api_secret }} ${{ secrets.xboard_api_url }}
      - name: Deploy crashgfw free-node-store
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: 'dest' 
          repository-name: crashgfw/free-node-store
          ssh-key: ${{ secrets.DEPLOY_KEY }}
          commit-message: "Update free subscription links"
      - name: update readme files
        run: node generate_markdown2.js ${{ secrets.xboard_api_secret }} ${{ secrets.xboard_api_url }}
      - name: Deploy crashgfw free-airport-nodes
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: 'dest2'
          branch: 'main'
          repository-name: crashgfw/free-airport-nodes
          ssh-key: ${{ secrets.DEPLOY_KEY2 }}
          commit-message: "Update free subscription links"
      - name: update free-proxy-nodes/free-nodes readme files
        run: node generate_markdown3.js ${{ secrets.xboard_api_secret }} ${{ secrets.xboard_api_url }}
      - name: Deploy free-proxy-nodes/free-nodes
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: 'dest3'
          branch: 'main'
          repository-name: free-proxy-nodes/free-nodes
          ssh-key: ${{ secrets.DEPLOY_KEY3 }}
          commit-message: "Update free subscription links"
      - name: update hiddifyapp350 readme files 
        run: node generate_markdown4.js ${{ secrets.xboard_api_secret }} ${{ secrets.xboard_api_url }}
      - name: Deploy free-proxy-nodes/free-nodes
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: 'dest4'
          branch: 'main'
          repository-name: VoroninaYanina/free-nodes
          ssh-key: ${{ secrets.DEPLOY_KEY4 }}
          commit-message: "Update free subscription links"

  update_hysteria350_free_jichang_readme:
    runs-on: ubuntu-latest
    needs: update_subscriptions
    steps:
      - name: Set up Docker
        uses: docker/setup-docker-action@v4
        with:
          version: "26.1.4"
          channel: test
      - run: docker version
      - run: docker info
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v4
      - name: update readme files
        run: node generate_markdown5.js ${{ secrets.xboard_api_secret }} ${{ secrets.xboard_api_url }}
      - name: Deploy crashgfw free-airport-nodes
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: 'dest5'
          branch: 'main'
          repository-name: hysteria350/free-jichang
          ssh-key: ${{ secrets.DEPLOY_KEY5 }}
          commit-message: "Update free subscription links"
